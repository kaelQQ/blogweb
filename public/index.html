<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Monolog - Share Your Stories</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet"/>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">Monolog</a>
            <div class="nav-links">
                <a href="/" class="active">Home</a>
                <a href="/write.html">Write</a>
            </div>
        </div>
    </nav>

    <div id="sidebar" class="sidebar">
        <button id="close-sidebar" class="close-btn">&times;</button>
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#about" onclick="showAbout()">About & Contact</a></li>
        </ul>
        <div id="about-section" class="sidebar-content" style="display: none;">
            <h3>About Monolog</h3>
            <p>Monolog is a platform where you can share your stories, ideas, and experiences with the world. Our mission is to connect people through the power of storytelling.</p>
            <h3>Contact Us</h3>
            <p>If you have any questions, feedback, or suggestions, feel free to reach out to us:</p>
            <ul>
                <li>Email: support@monolog.com</li>
                <li>Phone: +63 (945) 213-9935</li>
                <li>Address: USTP, Cagayan de Oro City</li>
            </ul>
        </div>
        <div class="sidebar-content">
            <h3>Categories</h3>
            <ul id="sidebar-categories"></ul>
        </div>
        <div class="sidebar-content">
            <h3>Tags</h3>
            <div id="sidebar-tags"></div>
        </div>
        <div class="sidebar-content">
            <h3>Recent Posts</h3>
            <ul id="sidebar-recent-posts"></ul>
        </div>
    </div>
    <button id="open-sidebar" class="open-btn">☰ Open Sidebar</button>

    <div class="hero">
        <h1>Welcome to Monolog</h1>
        <p>Share your stories, ideas, and experiences with the world.</p>
    </div>

    <div class="container">
    <div id="posts">
        <h2>Latest Stories</h2>
        <div class="sort-container">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select">
                <option value="createdAt-desc">Newest</option>
                <option value="createdAt-asc">Oldest</option>
                <option value="title-asc">Title A–Z</option>
                <option value="title-desc">Title Z–A</option>
                <option value="author-asc">Author A–Z</option>
                <option value="author-desc">Author Z–A</option>
                <option value="category-asc">Category A–Z</option>
                <option value="category-desc">Category Z–A</option>
            </select>
            <button onclick="getPosts()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="posts-list" id="posts-container"></div>
    </div>
</div>

    <script>
        // SIDEBAR
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        openSidebarBtn.addEventListener('click', () => {
            sidebar.style.width = '250px';
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.style.width = '0';
        });

        function showAbout() {
            const aboutSection = document.getElementById('about-section');
            // Toggle the display of the about section.
            // Using a class `active` in CSS is often cleaner for display toggling.
            aboutSection.classList.toggle('active');
        }

        // DISPLAY POSTS - Moved this function definition BEFORE getPosts()
        function displayPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';

            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post-card';

                const tagsDisplay = post.tags?.length ? post.tags.join(', ') : 'No tags';

                postElement.innerHTML = `
                    <img src="https://source.unsplash.com/featured/400x300?blog,${(post.category || 'uncategorized').toLowerCase()}" alt="${post.title}" class="post-image">
                    <div class="post-content">
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-excerpt">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</p>
                        <div class="post-metadata">
                            <div class="post-author">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(post.author || 'Anonymous')}&background=random" alt="${post.author}" class="author-avatar">
                                <span>${post.author || 'Anonymous'}</span>
                            </div>
                            <div class="post-info">
                                <span>${post.category || 'Uncategorized'}</span>
                            </div>
                        </div>
                        <div class="post-actions">
                            <div class="interaction-buttons">
                                <button class="heart-button" onclick="toggleHeart('${post._id}')">
                                    <i class="fas fa-heart"></i>
                                    <span class="heart-count" id="heart-count-${post._id}">${post.likes || 0}</span>
                                </button>
                                <button class="comment-button" onclick="toggleComments('${post._id}')">
                                    <i class="fas fa-comment"></i>
                                    <span class="comment-count" id="comment-count-${post._id}">0</span>
                                </button>
                            </div>
                            <button class="edit-btn" onclick="editPost('${post._id}')">Edit</button>
                            <button class="delete-btn" onclick="deletePost('${post._id}')">Delete</button>
                        </div>
                        <div class="comments-section" id="comments-${post._id}">
                            <div class="comments-section-content">
                                <h4>Discussion</h4>
                                <div class="comments-list"></div>
                            </div>
                            <div class="comment-form">
                                <h5 class="comment-form-title">Leave a Comment</h5>
                                <div class="comment-form-fields">
                                    <input type="text" id="comment-author-${post._id}" placeholder="Your Name" required>
                                    <textarea id="comment-content-${post._id}" placeholder="Share your thoughts..." rows="3" required></textarea>
                                    <button onclick="addComment('${post._id}')">Post Comment</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(postElement);
                getComments(post._id);
            });
        }

        // GET POSTS - Now displayPosts is defined before this is called
        async function getPosts() {
            try {
                const sortValue = document.getElementById('sort-select')?.value || 'createdAt-desc'; // Default to newest
                const [sortBy, order] = sortValue.split('-');
                const response = await fetch(`http://localhost:3000/api/posts?sortBy=${sortBy}&order=${order}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch posts');
                }
                const posts = await response.json();
                if (!Array.isArray(posts)) throw new Error('Invalid response format');
                displayPosts(posts);
            } catch (error) {
                console.error('Error fetching posts:', error); // Changed message for clarity
                alert('Error fetching posts: ' + error.message);
            }
        }

        // COMMENTS (These can stay where they are as they are called after displayPosts)
        async function getComments(postId) {
            try {
                const response = await fetch(`http://localhost:3000/api/posts/${postId}/comments`);
                const comments = await response.json();
                displayComments(postId, comments);
            } catch (error) {
                console.error('Error fetching comments:', error);
            }
        }

        function displayComments(postId, comments) {
            const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
            const commentCount = document.querySelector(`#comment-count-${postId}`);
            commentsList.innerHTML = '';
            commentCount.textContent = comments.length;

            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="no-comments">No comments yet. Be the first to share your thoughts!</p>';
                return;
            }

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-item';
                commentElement.innerHTML = `
                    <div class="comment-author">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(comment.author)}&background=random" alt="${comment.author}">
                        ${comment.author}
                    </div>
                    <div class="comment-content">${comment.content}</div>`;
                commentsList.appendChild(commentElement);
            });
        }

        async function addComment(postId) {
            const author = document.getElementById(`comment-author-${postId}`).value;
            const content = document.getElementById(`comment-content-${postId}`).value;
            if (!author || !content) {
                alert('Please enter your name and comment');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ author, content })
                });

                if (response.ok) {
                    alert('Comment added!');
                    // Instead of full getPosts(), just refresh comments for efficiency
                    getComments(postId);
                    document.getElementById(`comment-content-${postId}`).value = ''; // Clear comment input
                    document.getElementById(`comment-author-${postId}`).value = ''; // Clear author input
                } else {
                     const errorData = await response.json();
                     throw new Error(errorData.message || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment: ' + error.message);
            }
        }

        async function toggleHeart(postId) {
            try {
                const response = await fetch(`http://localhost:3000/api/posts/${postId}/like`, { method: 'POST' });
                // Assuming your backend sends back the updated post with new like count
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to like post');
                }
                const updatedPost = await response.json();
                document.getElementById(`heart-count-${postId}`).textContent = updatedPost.likes || 0;
            } catch (error) {
                console.error('Error liking post:', error);
                alert('Error liking post: ' + error.message);
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.querySelector(`#comments-${postId}`);
            commentsSection.classList.toggle('active');
            // If comments section is now active, fetch comments
            if (commentsSection.classList.contains('active')) {
                getComments(postId);
            }
        }

        async function editPost(id) {
            // This function needs to be implemented.
            // You'll likely want to redirect to a /write.html?edit=ID page
            // or open a modal with the post data pre-filled.
            alert('Edit functionality not yet implemented for post: ' + id);
            window.location.href = `/write.html?edit=${id}`; // Example redirect
        }

        async function deletePost(id) {
            if (confirm('Are you sure you want to delete this post? This cannot be undone.')) {
                try {
                    const response = await fetch(`http://localhost:3000/api/posts/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Post deleted successfully!');
                        getPosts(); // Refresh the list of posts
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to delete post');
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                    alert('Error deleting post: ' + error.message);
                }
            }
        }

        // FETCH SIDEBAR CONTENT
        async function fetchSidebarContent() {
            try {
                const response = await fetch('http://localhost:3000/api/posts/sidebar/content');
                if (!response.ok) {
                    console.error('Failed to fetch sidebar content');
                    return;
                }
                const data = await response.json();
                displaySidebarContent(data);
            } catch (error) {
                console.error('Error fetching sidebar content:', error);
            }
        }

        function displaySidebarContent(data) {
            const categoriesList = document.getElementById('sidebar-categories');
            const tagsContainer = document.getElementById('sidebar-tags');
            const recentPostsList = document.getElementById('sidebar-recent-posts');

            categoriesList.innerHTML = '';
            data.categories.forEach(category => {
                const li = document.createElement('li');
                // For filtering by category, you'd add an event listener or link
                li.innerHTML = `<a href="#" onclick="filterByCategory('${category}')">${category}</a>`;
                categoriesList.appendChild(li);
            });

            tagsContainer.innerHTML = '';
            data.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'tag';
                span.textContent = tag;
                // For filtering by tag, you'd add an event listener or link
                span.onclick = () => filterByTag(tag);
                tagsContainer.appendChild(span);
            });

            recentPostsList.innerHTML = '';
            data.recentPosts.forEach(post => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `/#post-${post._id}`; // Consider a dedicated single post page in the future
                a.textContent = post.title;
                li.appendChild(a);
                recentPostsList.appendChild(li);
            });
        }

        // --- NEW FILTERING FUNCTIONS (to be implemented on backend/frontend) ---
        function filterByCategory(category) {
            alert(`Filtering by category: ${category}. (Backend implementation needed)`);
            // You would then call getPosts() with a category filter parameter
            // e.g., getPosts({ category: category });
        }

        function filterByTag(tag) {
            alert(`Filtering by tag: ${tag}. (Backend implementation needed)`);
            // You would then call getPosts() with a tags filter parameter
            // e.g., getPosts({ tags: tag });
        }


        // Event listener for sort select dropdown
        document.getElementById("sort-select").addEventListener("change", getPosts);

        // Initial load of posts and sidebar content when the page loads
        window.onload = () => {
            getPosts();
            fetchSidebarContent();
        };
    </script>
</body>
</html>